clear all 
clc 

%% Setting up Parameters

y = 3; %number of years
T = 52*y; %number of weeks
N = 10000; %number of buses
dim = 175*y; %dimension of value function iteration

b = 0.999; %discount factor
rc = 10.896; %replacement cost
theta11 = 1.1732; %maintenance cost c = theta11*0.001*x

%Transition Probabilities
theta30 = 0.1191; % no increase
theta31 = 0.5762; %increase by 1
theta32 = 0.2868; %increase by 2
theta33 = 0.0158; %increase by 3

%% Value function iteration
EV = conditional_value(theta11,theta30,theta31,theta32,theta33,b,dim,rc)


%% Simulated data

X = zeros(T,N);
D = zeros(T,N);

% For t = 1
% Draw T1EV

error = rand(2,N);
error = 0.577 - log(-log(error));

p = rand(1,N);

for k = 1:N
    
   if p(k)<theta30
       X(1,k) = 0;
   elseif p(k)<theta30 + theta31
       X(1,k) = 1;
   elseif p(k)<theta30 + theta31 + theta32
       X(1,k) = 2;
   elseif p(k)<theta30 + theta31 + theta32 + theta33
       X(1,k) = 3;
   else
       X(1,k) = 1;
   end
   
   %Replacement decision
   NoReplace = -0.01*theta11*X(1,k) + error(1,k) + b*EV(X(1,k)+1,1);
   Replace = -rc + error(2,k) + b*EV(1,2);
   
   if Replace>NoReplace
       D(1,k) = 1;
   end
    
end

for t=2:T
    
    error = rand(2,N);
    error = 0.577 -log(-log(error));
    
    p = rand(1,N);
    
    for k = 1:N
        if D(t,k) == 1
            X(t,k) = 0;
        elseif p(1,k) <=theta30
            X(t,k) = X(t-1,k);
        elseif p(1,k) <=theta30 + theta31
            X(t,k) = X(t-1,k) + 1;
        elseif p(1,k) <=theta30 + theta31 + theta32
            X(t,k) = X(t-1,k) + 2;
        elseif p(1,k) <=theta30 + theta31 + theta32 + theta33
            X(t,k) = X(t-1,k) + 3;
        else
            X(t,k) = X(t-1,k) + 1; 
        end
                
        Replace = -rc + error(2,k) + b*EV(1,2);
            
        
    end
end